{{ $disableImageOptimization := .Site.Params.disableImageOptimization | default false }}
<style>
/* Hide default header on non-homepage pages where fixed top bar is shown */
/* Only hide the main page header, not article headers */
body:has(.fixed-top-bar) > header,
body:has(#fixed-top-bar) > header,
body:has(.fixed-top-bar) header:not(article header):not(.content-frosted-wrapper article header),
body:has(#fixed-top-bar) header:not(article header):not(.content-frosted-wrapper article header) {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  height: 0 !important;
  overflow: hidden !important;
}

/* Ensure article headers are always visible */
.content-frosted-wrapper article header,
article header {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  height: auto !important;
  overflow: visible !important;
}

/* Fixed top bar - Same as homepage, always visible on non-homepage pages */
#fixed-top-bar.fixed-top-bar,
.fixed-top-bar {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  z-index: 99999 !important;
  background: rgba(255, 255, 255, 0.2) !important;
  backdrop-filter: blur(20px) !important;
  -webkit-backdrop-filter: blur(20px) !important;
  padding: 0.75rem 2rem !important;
  transform: translateY(0) !important;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
              background 0.3s ease,
              transform 0.3s ease;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
  opacity: 1 !important;
  pointer-events: auto !important;
  visibility: visible !important;
  display: block !important;
  margin: 0 !important;
}

.dark .fixed-top-bar {
  background: rgba(255, 255, 255, 0.1) !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.fixed-top-bar-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
}

.fixed-top-left {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
}

.fixed-top-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.3);
  flex-shrink: 0;
}

.fixed-top-text {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  flex: 1;
}

.fixed-top-name-section {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.fixed-top-title {
  margin: 0;
  font-size: 1.1rem;
  font-weight: bold;
  color: #1a1a1a;
  text-shadow: none;
}

.dark .fixed-top-title {
  color: #f0f0f0;
}

.fixed-top-headline {
  margin: 0;
  font-size: 0.9rem;
  font-weight: normal;
  color: #4b5563;
  text-shadow: none;
  min-height: 1.2rem;
}

.dark .fixed-top-headline {
  color: #9ca3af;
}

.fixed-top-headline .cursor {
  display: inline-block;
  width: 2px;
  height: 0.9em;
  background-color: currentColor;
  margin-left: 2px;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

.fixed-top-links {
  display: flex;
  gap: 0.5rem;
  font-size: 1.1rem;
  margin-left: 0;
}

.fixed-top-link {
  color: #1a1a1a;
  opacity: 0.8;
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.dark .fixed-top-link {
  color: #f0f0f0;
}

.fixed-top-link:hover {
  opacity: 1;
  transform: scale(1.1);
}

.fixed-top-right {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-left: auto;
}

/* Fixed top menu styling */
.fixed-top-right nav {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.fixed-top-right a,
.fixed-top-right button {
  color: #1a1a1a;
  opacity: 0.8;
  transition: opacity 0.2s ease, transform 0.2s ease;
  text-decoration: none;
  font-size: 0.95rem;
}

.dark .fixed-top-right a,
.dark .fixed-top-right button {
  color: #f0f0f0;
}

.fixed-top-right a:hover,
.fixed-top-right button:hover {
  opacity: 1;
  transform: translateY(-1px);
}

/* Add padding to main content to account for fixed top bar */
body:has(.fixed-top-bar) main#main-content {
  padding-top: 70px !important;
}

@media (max-width: 768px) {
  .fixed-top-bar {
    padding: 0.5rem 1rem;
  }
  
  .fixed-top-title {
    font-size: 0.95rem;
  }
  
  .fixed-top-headline {
    font-size: 0.8rem;
  }
  
  .fixed-top-avatar {
    width: 32px;
    height: 32px;
  }
  
  body:has(.fixed-top-bar) main#main-content {
    padding-top: 60px !important;
  }
}
</style>

<!-- Fixed Top Bar - Same as homepage -->
<!-- Debug: IsHome = {{ .IsHome }}, Page = {{ .Title }} -->
<div id="fixed-top-bar" class="fixed-top-bar{{ if .IsHome }} global-fixed-top-bar{{ end }}" style="display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 99999 !important;">
  <div class="fixed-top-bar-content">
    <div class="fixed-top-left">
      {{/* Use avatar.jpg from static directory */}}
      {{ $avatarPath := "avatar.jpg" }}
      {{ $avatarImage := resources.Get $avatarPath }}
      {{ if $avatarImage }}
        {{ $final := $avatarImage }}
        {{ if not $disableImageOptimization }}
          {{ $final = $avatarImage.Fill (print "80x80 q" ( $.Site.Params.Author.imagequality | default "96" )) }}
        {{ end }}
        <img
          class="fixed-top-avatar"
          width="40"
          height="40"
          alt="{{ $.Site.Params.Author.name | default `Author` }}"
          src="{{ $final.RelPermalink }}">
      {{ else }}
        {{/* Fallback to Author.image if avatar.jpg doesn't exist */}}
        {{ with .Site.Params.Author.image }}
          {{ $authorImage := "" }}
          {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
            {{ $authorImage = resources.GetRemote . }}
          {{ else }}
            {{ $authorImage = resources.Get . }}
          {{ end }}
          {{ if $authorImage }}
            {{ $final := $authorImage }}
            {{ if not $disableImageOptimization }}
              {{ $final = $authorImage.Fill (print "80x80 q" ( $.Site.Params.Author.imagequality | default "96" )) }}
            {{ end }}
            <img
              class="fixed-top-avatar"
              width="40"
              height="40"
              alt="{{ $.Site.Params.Author.name | default `Author` }}"
              src="{{ $final.RelPermalink }}">
          {{ end }}
        {{ end }}
      {{ end }}
      <div class="fixed-top-text">
        <div class="fixed-top-name-section">
          <h1 class="fixed-top-title">{{ .Site.Params.Author.name | default .Site.Title }}</h1>
          {{ with .Site.Params.Author.links }}
            <div class="fixed-top-links">
              {{ range $links := . }}
                {{ range $name, $url := $links }}
                  <a
                    class="fixed-top-link"
                    href="{{ $url }}"
                    target="_blank"
                    aria-label="{{ $name | title }}"
                    title="{{ $name | title }}"
                    rel="me noopener noreferrer">
                    {{ partial "icon.html" $name }}
                  </a>
                {{ end }}
              {{ end }}
            </div>
          {{ end }}
        </div>
        <h2 class="fixed-top-headline" id="fixed-top-typewriter-headline" data-signature-pattern="signature" data-speed="100" data-initialized="false">
          <!-- Typewriter text will appear here -->
        </h2>
      </div>
    </div>
    <div class="fixed-top-right" id="fixed-top-menu">
      <!-- Navigation menu will be inserted here by JavaScript -->
    </div>
  </div>
</div>

<script>
// Typewriter effect for fixed top bar - uses shared function
(function() {
  function initFixedTopTypewriter() {
    if (window.initTypewriterEffect) {
      // Try up to 100 files to discover all signature files dynamically
      window.initTypewriterEffect('fixed-top-typewriter-headline', { maxFiles: 100 });
    } else {
      console.error('Shared typewriter function not loaded');
      const element = document.getElementById('fixed-top-typewriter-headline');
      if (element) {
        element.textContent = "I'm only human";
      }
    }
  }
  
  // Initialize when DOM is ready - with retry mechanism
  function init() {
    // Wait a bit to ensure DOM is fully ready and shared function is loaded
    setTimeout(function() {
      if (window.initTypewriterEffect) {
        initFixedTopTypewriter();
      } else {
        // Retry if shared function not loaded yet
        setTimeout(init, 100);
      }
    }, 100);
  }
  
  // Multiple initialization attempts to ensure it works on all pages
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // Retry after short delay
  setTimeout(init, 500);
  
  // Also try after a longer delay to ensure element exists (for dynamically loaded content)
  setTimeout(function() {
    if (window.initTypewriterEffect) {
      initFixedTopTypewriter();
    }
  }, 2000);
  
  // Final retry after page fully loaded
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (window.initTypewriterEffect) {
        const element = document.getElementById('fixed-top-typewriter-headline');
        if (element) {
          element.dataset.typewriterInitialized = 'false'; // Reset to allow reinitialization
          initFixedTopTypewriter();
        }
      }
    }, 500);
  });
  
  // Listen for custom event to force reinitialization
  document.addEventListener('forceTypewriterInit', function() {
    if (window.initTypewriterEffect) {
      const element = document.getElementById('fixed-top-typewriter-headline');
      if (element) {
        element.dataset.typewriterInitialized = 'false';
        initFixedTopTypewriter();
      }
    }
  });
})();
</script>

<script>
// Copy navigation menu to fixed top bar - Same logic as homepage
(function() {
  let menuCopied = false; // Flag to prevent multiple copies
  
  function initFixedMenu() {
    // Prevent multiple calls
    if (menuCopied) {
      return;
    }
    
    const fixedMenuContainer = document.getElementById('fixed-top-menu');
    if (!fixedMenuContainer) {
      return;
    }
    
    // Check if menu already exists
    if (fixedMenuContainer.children.length > 0) {
      menuCopied = true;
      return;
    }
    
    // Wait for DOM to be ready
    function tryCopyMenu() {
      // Prevent multiple copies
      if (menuCopied || fixedMenuContainer.children.length > 0) {
        return;
      }
      
      // Try multiple selectors to find the navigation menu
      // First try to find menu in visible header (if header is not hidden)
      let originalMenu = document.querySelector('header:not([style*="display: none"]) nav.hidden.md\\:flex');
      if (!originalMenu) {
        originalMenu = document.querySelector('header nav.hidden.md\\:flex');
      }
      if (!originalMenu) {
        originalMenu = document.querySelector('.main-menu nav.hidden.md\\:flex');
      }
      if (!originalMenu) {
        originalMenu = document.querySelector('nav.hidden.md\\:flex');
      }
      if (!originalMenu) {
        originalMenu = document.querySelector('header nav');
      }
      if (!originalMenu) {
        originalMenu = document.querySelector('.main-menu > div > nav');
      }
      // If still not found, try to find menu from homepage fixed top bar
      if (!originalMenu) {
        const homepageFixedMenu = document.querySelector('#fixed-top-menu');
        if (homepageFixedMenu && homepageFixedMenu.children.length > 0) {
          originalMenu = homepageFixedMenu.querySelector('nav');
        }
      }
      
      if (originalMenu && !menuCopied) {
        // Clear container first
        fixedMenuContainer.innerHTML = '';
        
        const clonedMenu = originalMenu.cloneNode(true);
        clonedMenu.classList.remove('hidden');
        clonedMenu.style.display = 'flex';
        clonedMenu.style.alignItems = 'center';
        clonedMenu.style.gap = '1rem';
        clonedMenu.style.flexWrap = 'nowrap';
        
        // Check if cloned menu already contains search and appearance switcher
        const clonedSearchButton = clonedMenu.querySelector('#search-button');
        const clonedAppearanceSwitcher = clonedMenu.querySelector('#appearance-switcher');
        
        // Remove duplicate search buttons and appearance switchers from cloned menu
        if (clonedSearchButton) {
          clonedSearchButton.id = 'fixed-search-button';
          // Re-attach event listener
          const originalSearchButton = document.getElementById('search-button');
          if (originalSearchButton) {
            clonedSearchButton.addEventListener('click', function(e) {
              e.preventDefault();
              originalSearchButton.click();
            });
          }
        }
        
        if (clonedAppearanceSwitcher) {
          clonedAppearanceSwitcher.id = 'fixed-appearance-switcher';
          // Re-attach event listener
          const originalAppearanceSwitcher = document.getElementById('appearance-switcher');
          if (originalAppearanceSwitcher) {
            clonedAppearanceSwitcher.addEventListener('click', function(e) {
              e.preventDefault();
              originalAppearanceSwitcher.click();
            });
          }
        }
        
        fixedMenuContainer.appendChild(clonedMenu);
        menuCopied = true;
        
        // Only add search and appearance switcher if they are NOT already in the cloned menu
        if (!clonedSearchButton) {
          const searchButton = document.getElementById('search-button');
          if (searchButton && !document.getElementById('fixed-search-button')) {
            const clonedSearch = searchButton.cloneNode(true);
            clonedSearch.id = 'fixed-search-button';
            fixedMenuContainer.appendChild(clonedSearch);
            
            // Re-attach event listeners
            clonedSearch.addEventListener('click', function(e) {
              e.preventDefault();
              searchButton.click();
            });
          }
        }
        
        if (!clonedAppearanceSwitcher) {
          const appearanceSwitcher = document.getElementById('appearance-switcher');
          if (appearanceSwitcher && !document.getElementById('fixed-appearance-switcher')) {
            const clonedSwitcher = appearanceSwitcher.cloneNode(true);
            clonedSwitcher.id = 'fixed-appearance-switcher';
            fixedMenuContainer.appendChild(clonedSwitcher);
            
            // Re-attach event listeners
            clonedSwitcher.addEventListener('click', function(e) {
              e.preventDefault();
              appearanceSwitcher.click();
            });
          }
        }
      } else if (!menuCopied) {
        // Retry only once after a delay
        setTimeout(function() {
          if (!menuCopied && fixedMenuContainer.children.length === 0) {
            tryCopyMenu();
          }
        }, 300);
      }
    }
    
    // Try immediately and with minimal delay
    tryCopyMenu();
    setTimeout(tryCopyMenu, 100);
  }
  
  // Initialize when DOM is ready - optimized for faster loading
  function init() {
    // Ensure fixed top bar is visible immediately
    const fixedTopBar = document.getElementById('fixed-top-bar');
    if (fixedTopBar) {
      fixedTopBar.style.setProperty('display', 'block', 'important');
      fixedTopBar.style.setProperty('visibility', 'visible', 'important');
      fixedTopBar.style.setProperty('opacity', '1', 'important');
      fixedTopBar.style.setProperty('z-index', '99999', 'important');
    }
    
    // Initialize menu with minimal delay
    initFixedMenu();
    setTimeout(initFixedMenu, 50);
  }
  
  // Run immediately if DOM is ready, otherwise wait for DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // Fallback with minimal delay
  setTimeout(function() {
    const fixedTopBar = document.getElementById('fixed-top-bar');
    if (fixedTopBar) {
      fixedTopBar.style.setProperty('display', 'block', 'important');
      fixedTopBar.style.setProperty('visibility', 'visible', 'important');
      fixedTopBar.style.setProperty('opacity', '1', 'important');
      fixedTopBar.style.setProperty('z-index', '99999', 'important');
    }
    if (!menuCopied) {
      initFixedMenu();
    }
  }, 200);
})();
</script>

{{/* Only show on non-homepage pages - Hide global fixed top bar on homepage (homepage has its own) */}}
{{ if .IsHome }}
<style>
/* Hide global fixed top bar on homepage - homepage has its own fixed top bar */
body:has(.hero-section) #fixed-top-bar.global-fixed-top-bar,
body:has(.hero-section) .global-fixed-top-bar {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  height: 0 !important;
  overflow: hidden !important;
  pointer-events: none !important;
}
</style>
{{ end }}
