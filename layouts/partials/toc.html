<details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    {{ i18n "article.table_of_contents" }}
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    {{ .TableOfContents | emojify }}
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    {{ i18n "article.table_of_contents" }}
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    {{ .TableOfContents | emojify }}
  </div>
</details>

{{ if .Site.Params.smartTOC }}
<script>
  console.log('smartTOC script loading...')
  (function () {
    'use strict'
    console.log('smartTOC script executing...')

    const SCROLL_OFFSET_RATIO = 0.33
    // 尝试多个可能的 TOC 选择器
    const TOC_SELECTORS = ['#TableOfContents', 'nav#TableOfContents', '.toc ul', '.toc nav', '#TOCView ul', '#TOCView nav']
    const ANCHOR_SELECTOR = '.anchor'
    const TOC_LINK_SELECTOR = 'a[href^="#"]'
    const NESTED_LIST_SELECTOR = 'li ul'
    const ACTIVE_CLASS = 'active'
    let isJumpingToAnchor = false
    let toc = null

    // 查找 TOC 元素
    function findTOC() {
      if (toc) return toc
      for (const selector of TOC_SELECTORS) {
        const element = document.querySelector(selector)
        if (element) {
          toc = element
          console.log('TOC found with selector:', selector)
          return element
        }
      }
      // 如果都找不到，尝试在 TOCView 内查找
      const tocView = document.querySelector('#TOCView')
      if (tocView) {
        const nav = tocView.querySelector('nav')
        const ul = tocView.querySelector('ul')
        toc = nav || ul || tocView
        if (toc) {
          console.log('TOC found in #TOCView')
          return toc
        }
      }
      return null
    }

    function getActiveAnchorId(anchors, offsetRatio) {
      if (!toc) return ''
      
      const threshold = window.scrollY + window.innerHeight * offsetRatio
      const tocLinks = [...toc.querySelectorAll('a[href^="#"]')]
      const tocIds = new Set(tocLinks.map(link => {
        const href = link.getAttribute('href')
        return href ? href.substring(1) : ''
      }).filter(id => id))

      if (isJumpingToAnchor) {
        for (let i = 0; i < anchors.length; i++) {
          const anchor = anchors[i]
          if (!anchor.id || !tocIds.has(anchor.id)) continue
          const top = anchor.getBoundingClientRect().top + window.scrollY
          if (Math.abs(window.scrollY - top) < 100) {
            return anchor.id
          }
        }
      }

      // 从下往上查找第一个在阈值之上的锚点
      for (let i = anchors.length - 1; i >= 0; i--) {
        const anchor = anchors[i]
        if (!anchor.id || !tocIds.has(anchor.id)) continue
        const top = anchor.getBoundingClientRect().top + window.scrollY
        if (top <= threshold) {
          return anchor.id
        }
      }
      
      // 如果没找到，返回第一个匹配的锚点
      const firstMatch = anchors.find(anchor => anchor.id && tocIds.has(anchor.id))
      return firstMatch ? firstMatch.id : ''
    }

    function updateTOC({ anchors, links, scrollOffset, collapseInactive }) {
      if (!toc) return
      
      const activeId = getActiveAnchorId(anchors, scrollOffset)
      if (!activeId) {
        // 清除所有 active 状态
        links.forEach(link => link.classList.remove(ACTIVE_CLASS))
        return
      }

      let hasActive = false
      links.forEach(link => {
        const href = link.getAttribute('href')
        const linkId = href ? href.substring(1) : ''
        const isActive = linkId === activeId
        
        if (isActive) {
          hasActive = true
        }
        
        link.classList.toggle(ACTIVE_CLASS, isActive)

        if (collapseInactive) {
          const ul = link.closest('li')?.querySelector('ul')
          if (ul) ul.style.display = isActive ? '' : 'none'
        }
      })

      if (collapseInactive && hasActive) {
        const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
        if (activeLink) {
          let el = activeLink
          while (el && el !== toc) {
            if (el.tagName === 'UL') el.style.display = ''
            if (el.tagName === 'LI') el.querySelector('ul')?.style.setProperty('display', '')
            el = el.parentElement
          }
        }
      }
      
      // 自动滚动到激活的链接（如果链接不在可视区域内）
      const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
      if (activeLink) {
        const tocContainer = document.querySelector('#TOCView')
        if (tocContainer) {
          const linkRect = activeLink.getBoundingClientRect()
          const containerRect = tocContainer.getBoundingClientRect()
          
          // 如果激活的链接不在可视区域内，滚动到它
          if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
            // 使用 requestAnimationFrame 确保平滑滚动
            requestAnimationFrame(() => {
              activeLink.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'nearest'
              })
            })
          }
        }
      }
    }

    function initTOC() {
      toc = findTOC()
      if (!toc) {
        console.warn('TOC not found, trying selectors:', TOC_SELECTORS)
        // 延迟重试
        setTimeout(initTOC, 500)
        return
      }

      const collapseInactive = {{ if site.Params.smartTOCHideUnfocusedChildren }}true{{ else }}false{{ end }}
      const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)]
      const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)]

      console.log('TOC initialized:', {
        anchors: anchors.length,
        links: links.length,
        toc: toc.tagName
      })

      if (anchors.length === 0) {
        console.warn('No anchors found with selector:', ANCHOR_SELECTOR)
      }
      
      if (links.length === 0) {
        console.warn('No TOC links found in:', toc)
      }

      if (collapseInactive) {
        toc.querySelectorAll(NESTED_LIST_SELECTOR).forEach(ul => ul.style.display = 'none')
      }

      links.forEach(link => {
        link.addEventListener('click', () => {
          isJumpingToAnchor = true
          setTimeout(() => {
            isJumpingToAnchor = false
          }, 1000)
        })
      })

      const config = {
        anchors,
        links,
        scrollOffset: SCROLL_OFFSET_RATIO,
        collapseInactive
      }

      // 使用节流优化滚动性能
      let ticking = false
      function onScroll() {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateTOC(config)
            ticking = false
          })
          ticking = true
        }
      }

      window.addEventListener('scroll', onScroll, { passive: true })
      window.addEventListener('hashchange', () => updateTOC(config), { passive: true })

      // 初始更新
      updateTOC(config)
      
      // 延迟更新，确保页面完全加载
      setTimeout(() => updateTOC(config), 200)
      setTimeout(() => updateTOC(config), 1000)
    }

    // 确保在 DOM 加载完成后初始化
    console.log('Setting up TOC initialization, readyState:', document.readyState)
    if (document.readyState === 'loading') {
      console.log('Waiting for DOMContentLoaded...')
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded fired, initializing TOC...')
        initTOC()
      })
    } else {
      // DOM 已经加载完成，延迟一点确保所有内容都渲染完成
      console.log('DOM already loaded, initializing TOC with delay...')
      setTimeout(function() {
        console.log('Delayed initialization starting...')
        initTOC()
      }, 100)
    }
  })()
  console.log('smartTOC script loaded')
</script>
{{ else }}
<script>
  console.warn('smartTOC is disabled in config')
</script>
{{ end }}

