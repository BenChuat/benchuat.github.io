<details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    {{ i18n "article.table_of_contents" }}
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    {{ .TableOfContents | emojify }}
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    {{ i18n "article.table_of_contents" }}
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    {{ .TableOfContents | emojify }}
  </div>
</details>

{{/* TOC 高亮功能 - 应用到所有文章页面 */}}
<script>
(function() {
  'use strict';
  
  console.log('[TOC] Script loading...');
  
  const SCROLL_OFFSET_RATIO = 0.33;
  const TOC_SELECTORS = [
    '#TableOfContents', 
    'nav#TableOfContents', 
    '.toc ul', 
    '.toc nav', 
    '#TOCView ul', 
    '#TOCView nav', 
    '#TOCView div ul',
    '#TOCView > div > ul'
  ];
  const ANCHOR_SELECTOR = '.anchor';
  const TOC_LINK_SELECTOR = 'a[href^="#"]';
  const ACTIVE_CLASS = 'active';
  let isJumpingToAnchor = false;
  let toc = null;

  function findTOC() {
    if (toc) return toc;
    
    for (const selector of TOC_SELECTORS) {
      const element = document.querySelector(selector);
      if (element) {
        toc = element;
        console.log('[TOC] Found with selector:', selector);
        return element;
      }
    }
    
    const tocView = document.querySelector('#TOCView');
    if (tocView) {
      const nav = tocView.querySelector('nav');
      const ul = tocView.querySelector('ul');
      const divWithUl = tocView.querySelector('div > ul');
      toc = nav || ul || divWithUl || tocView.querySelector('div');
      if (toc) {
        console.log('[TOC] Found in #TOCView:', toc.tagName);
        return toc;
      }
    }
    
    return null;
  }

  function getActiveAnchorId(anchors, offsetRatio) {
    if (!toc) return '';
    
    const threshold = window.scrollY + window.innerHeight * offsetRatio;
    const tocLinks = [...toc.querySelectorAll('a[href^="#"]')];
    const tocIds = new Set(tocLinks.map(link => {
      const href = link.getAttribute('href');
      return href ? href.substring(1) : '';
    }).filter(id => id));

    if (isJumpingToAnchor) {
      for (let i = 0; i < anchors.length; i++) {
        const anchor = anchors[i];
        if (!anchor.id || !tocIds.has(anchor.id)) continue;
        const top = anchor.getBoundingClientRect().top + window.scrollY;
        if (Math.abs(window.scrollY - top) < 100) {
          return anchor.id;
        }
      }
    }

    for (let i = anchors.length - 1; i >= 0; i--) {
      const anchor = anchors[i];
      if (!anchor.id || !tocIds.has(anchor.id)) continue;
      const top = anchor.getBoundingClientRect().top + window.scrollY;
      if (top <= threshold) {
        return anchor.id;
      }
    }
    
    const firstMatch = anchors.find(anchor => anchor.id && tocIds.has(anchor.id));
    return firstMatch ? firstMatch.id : '';
  }

  function updateTOC(config) {
    if (!toc) {
      toc = findTOC();
      if (!toc) return;
    }
    
    const activeId = getActiveAnchorId(config.anchors, config.scrollOffset);
    if (!activeId) {
      config.links.forEach(link => link.classList.remove(ACTIVE_CLASS));
      return;
    }

    let hasActive = false;
    config.links.forEach(link => {
      const href = link.getAttribute('href');
      const linkId = href ? href.substring(1) : '';
      const isActive = linkId === activeId;
      
      if (isActive && !hasActive) {
        hasActive = true;
      }
      
      link.classList.toggle(ACTIVE_CLASS, isActive);
    });
    
    if (hasActive) {
      const activeLink = toc.querySelector('a[href="#' + CSS.escape(activeId) + '"]');
      if (activeLink) {
        const tocContainer = document.querySelector('#TOCView');
        if (tocContainer) {
          const linkRect = activeLink.getBoundingClientRect();
          const containerRect = tocContainer.getBoundingClientRect();
          
          if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
            requestAnimationFrame(function() {
              activeLink.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'nearest'
              });
            });
          }
        }
      }
    }
  }

  function initTOC() {
    toc = findTOC();
    if (!toc) {
      console.warn('[TOC] Not found, retrying...');
      setTimeout(initTOC, 200);
      return;
    }

    const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)];
    const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)];

    console.log('[TOC] Initialized:', {
      anchors: anchors.length,
      links: links.length,
      toc: toc.tagName
    });

    if (anchors.length === 0) {
      console.warn('[TOC] No anchors found');
    }
    
    if (links.length === 0) {
      console.warn('[TOC] No links found');
    }

    links.forEach(function(link) {
      link.addEventListener('click', function() {
        isJumpingToAnchor = true;
        setTimeout(function() {
          isJumpingToAnchor = false;
        }, 1000);
      });
    });

    const config = {
      anchors: anchors,
      links: links,
      scrollOffset: SCROLL_OFFSET_RATIO,
      collapseInactive: false
    };

    let ticking = false;
    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          updateTOC(config);
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('hashchange', function() {
      updateTOC(config);
    }, { passive: true });

    updateTOC(config);
    setTimeout(function() {
      updateTOC(config);
    }, 300);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTOC);
  } else {
    setTimeout(initTOC, 50);
  }
})();
</script>
